---
title: "MyND Variance Partition"
subtitle: " "
author: |
 | Evan Udine
 | Elisa Navarro
 | Raj Lab
 | Department of Neuroscience
 | Icahn School of Medicine at Mount Sinai
 | NYC, New York
date: "`r Sys.Date()`"
output:
 rmarkdown::html_document:
   theme: spacelab
   highlight: zenburn
   code_folding: show
   toc: true
   toc_float: true
   smooth_scroll: true
   number_sections: false
   self_contained: true  
---


```{r load.packages, echo=FALSE, message=FALSE, results='hide'}
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
if(!require("variancePartition")) BiocManager::install("variancePartition"); library("variancePartition")
if(!require("doParallel")) install.packages("doParallel"); library("doParallel")
knitr::opts_chunk$set( 
  warning=FALSE,
  message=FALSE,
  results = 'hide',
  error = FALSE,
  tidy = FALSE,
  fig.show = "hold")
```

## Input data
```{r load.data, echo=TRUE}
#load reads:
#If tpms:
geneExp <- read.table("/sc/hydra/projects/pd-omics/mynd/analyses/analysis_9_19_19/mynd.tpms.txt", header = TRUE, row.names = 1, check.names = F)

#Load covariates
info <- read.table("/sc/hydra/projects/pd-omics/mynd/analyses/analysis_9_19_19/mynd_metadata_9_19_19.txt", header = TRUE, row.names = 1)

info$Exonic.Rate = 100*info$Exonic.Rate
info$rRNA.rate=100*info$rRNA.rate
info$End.2.Mapping.Rate=100*info$End.2.Mapping.Rate
info$Intergenic.Rate=100*info$Intergenic.Rate
info$Intronic.Rate=100*info$Intronic.Rate
info$Expression.Profiling.Efficiency=100*info$Expression.Profiling.Efficiency
info$Mapped=info$Mapped/100000
info$rna_batch=as.factor(info$rna_batch)
info$library_batch=as.factor(info$library_batch)
info$lane=as.factor(info$lane)
info$season=as.factor(info$season)
info$processing_pipeline = as.factor(info$processing_pipeline)
info1 <- info[colnames(geneExp),]

#After sure that they are similar, force them.
identical(colnames(geneExp), rownames(info1))
```

### Violin Plot
```{r violion.partition, echo=TRUE, fig.width=14, fig.height=8, res = 300}
#removed all low expressed genes
ge <- geneExp[ rowMeans(geneExp) > 1, ] #Let's check if that's a good threshold

#Variables to run Variance Partition with selected variables. Remember (1|..) for factors!
form <- ~ (1|status) + (1|gender) + age + mds1 + mds2 + mds3 + mds4 + (1|rna_batch)

#Variables to do the diagram for selected variables:
form_1 <- ~ status + gender + mds1 + mds2 + mds3 + mds4 + age + rna_batch

#The variance partiation run:
varPart <- fitExtractVarPartModel( ge, form, info1 )
vp <- sortCols ( varPart )
plotVarPart ( vp )

#Diagram for correlation between variables:
C= canCorPairs(form_1, info1)
plotCorrMatrix( C )
```

### Correlation
```{r heatmap.partition, echo=TRUE, fig.width=10, fig.height=6, res = 300}
#Diagram for correlation between variables:

#C= canCorPairs(form_1, info1)
#plotCorrMatrix( C )
```
